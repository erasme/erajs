<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
    <title>Test Transformable</title>
    <script src='../../era/era-debug.js'></script>
<script>

Ui.App.extend('Test.App', {
	constructor: function(config) {
		var lbox = new Ui.LBox({ verticalAlign: 'center', horizontalAlign: 'center',
			width: 400, height: 400 });
		this.setContent(lbox);

		lbox.append(new Ui.Frame({ fill: 'pink', frameWidth: 2 }));

		var transformable = new Ui.Transformable({ margin: 2, inertia: false, clipToBounds: true });
		lbox.append(transformable);
		this.connect(transformable, 'transform', this.onTransform);

//		transformable.setContent(new Ui.Rectangle({ fill: 'green' }));
		transformable.setContent(new Ui.Image({ src: '6wind.jpg', width: 400 }));
	},

	onTransform: function(transformable) {
		var w = transformable.getLayoutWidth();
		var h = transformable.getLayoutHeight();

		this.disconnect(transformable, 'transform', this.onTransform);

		var scale = transformable.getScale();
		var x = transformable.getTranslateX();
		var y = transformable.getTranslateY();

		scale = Math.min(4, Math.max(1, scale));

		var sw = w * scale;
		var dw = (sw - w)/2;

		var sh = h * scale;
		var dh = (sh - h)/2;

//		console.log('onTransform scale: '+scale+', x: '+x+', lw: '+w+', dw: '+dw);

		x = Math.min(x, dw);
		x = Math.max(x, -dw);

		y = Math.min(y, dh);
		y = Math.max(y, -dh);

		transformable.setContentTransform(x, y, scale, 0);

		console.log(transformable.getMatrix().toString());
		this.connect(transformable, 'transform', this.onTransform);
	}
});

new Test.App();

/*
var app = new Ui.App();

// define a playing area
var fixed = new Ui.Fixed();
app.setContent(fixed);

//
// If nothing special specified, the transformable
// has no limit
//
var transformable = new Ui.Transformable();
var lbox = new Ui.LBox();
lbox.append(new Ui.Rectangle({ width: 150, height: 150, fill: 'orange', radius: 8 }));
lbox.append(new Ui.Label({ text: 'free transform' }));
transformable.setContent(lbox);
fixed.append(transformable, 50, 50);

//
// Define another transformable but attach a function to the
// transform event. The transform event allow the application
// to known what transform are applied. It also allow to limit
// the transformation by using the setContentTransform and change
// some transform properties.
// In this example, the element move is disabled by always setting
// x = 0 and y = 0.
//
function onRotateScaleTransform(transformable) {
	app.disconnect(transformable, 'transform', onRotateScaleTransform);
	transformable.setContentTransform(0, 0, undefined, undefined);
	app.connect(transformable, 'transform', onRotateScaleTransform);
};
transformable = new Ui.Transformable();
lbox = new Ui.LBox();
lbox.append(new Ui.Rectangle({ width: 150, height: 150, fill: 'lightgreen', radius: 8 }));
lbox.append(new Ui.Label({ text: 'rotate/scale' }));
transformable.setContent(lbox);
fixed.append(transformable, 350, 50);
app.connect(transformable, 'transform', onRotateScaleTransform);


//
// In this example, the element scale is limited between 1 and 2
//
function onLimitedScaleTransform(transformable) {
	var scale = transformable.getScale();
	if((scale < 1) || (scale > 2)) {
		scale = Math.min(2, Math.max(1, scale));
		app.disconnect(transformable, 'transform', onLimitedScaleTransform);
		transformable.setContentTransform(undefined, undefined, scale, undefined);
		app.connect(transformable, 'transform', onLimitedScaleTransform);
	}
};
transformable = new Ui.Transformable();
lbox = new Ui.LBox();
lbox.append(new Ui.Rectangle({ width: 150, height: 150, fill: 'lightblue', radius: 8 }));
lbox.append(new Ui.Label({ text: 'limited scale 2x' }));
transformable.setContent(lbox);
fixed.append(transformable, 50, 350);
app.connect(transformable, 'transform', onLimitedScaleTransform);


//
// In this example, the element rotation jump between 90 degree step values
//
function onStepRotateTransform(transformable) {
	var angle = transformable.getAngle();
	angle = Math.round(angle / 90) * 90;
	app.disconnect(transformable, 'transform', onStepRotateTransform);
	transformable.setContentTransform(0, 0, 1, angle);
	app.connect(transformable, 'transform', onStepRotateTransform);
};
transformable = new Ui.Transformable();
lbox = new Ui.LBox();
lbox.append(new Ui.Rectangle({ width: 150, height: 150, fill: 'pink', radius: 8 }));
lbox.append(new Ui.Label({ text: 'step rotate' }));
transformable.setContent(lbox);
fixed.append(transformable, 350, 350);
app.connect(transformable, 'transform', onStepRotateTransform);

//
// This example, just demonstrate that we can put button in the content
// of a transformable.
//
transformable = new Ui.Transformable();
lbox = new Ui.LBox();
lbox.append(new Ui.Rectangle({ width: 150, height: 150, fill: 'purple', radius: 8 }));
var vbox = new Ui.VBox({ uniform: true, padding: 20 });
lbox.append(vbox);
vbox.append(new Ui.Button({ text: 'button1' }));
vbox.append(new Ui.Button({ text: 'button2' }));
vbox.append(new Ui.Button({ text: 'button3' }));
transformable.setContent(lbox);
fixed.append(transformable, 650, 50);
*/

</script>
  </head>
</html>
